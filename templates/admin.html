<!DOCTYPE html>
<html>
<head>
    <title>Transport Tracker - Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0b0c10; color:#e6eef8; padding:24px; }
        .panel { max-width:1400px; margin: 0 auto; background: #0d1117; border-radius:12px; padding:18px; border:1px solid rgba(255,255,255,0.04); box-shadow: none }
        h1 { margin:0 0 6px 0; font-size:20px }
        p.subtitle { margin:0 0 14px 0; color:#9aa4b2 }
        .controls { display:flex; gap:10px; align-items:center; margin-bottom:12px; flex-wrap:wrap }
        input, select, textarea { padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:#0f0f23; color:#e6eef8 }
        button { background:#0f0f23; color:#e6eef8; border:1px solid rgba(255,255,255,0.06); padding:8px 12px; border-radius:10px; cursor:pointer }
        button:hover { background:rgba(255,255,255,0.05) }
        table { width:100%; border-collapse:collapse; margin-top:12px }
        thead th { text-align:left; padding:10px; font-size:13px; color:#9aa4b2; border-bottom:1px solid rgba(255,255,255,0.03) }
        tbody td { padding:10px; vertical-align:middle; border-bottom:1px dashed rgba(255,255,255,0.02) }
        .small { font-size:13px; color:#9aa4b2 }
        .muted { color:#8893a6 }
        .danger { color:#ff7b8a; border-color: rgba(255,123,138,0.12) }
        .ok { color:#34d399; border-color: rgba(52,211,153,0.08) }
        .row-actions button { margin-right:8px }
        .empty { text-align:center; color:#8290a3; padding:20px }
        .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:20px }
        .tabs { display:flex; gap:8px; border-bottom:1px solid rgba(255,255,255,0.03); margin-bottom:18px }
        .tab { padding:10px 16px; cursor:pointer; color:#9aa4b2; border-bottom:2px solid transparent }
        .tab.active { color:#e6eef8; border-bottom-color:#34d399 }
        .tab-content { display:none }
        .tab-content.active { display:block }
        .field-group { margin-bottom:12px }
        .field-label { font-size:12px; color:#9aa4b2; margin-bottom:4px; display:block; font-weight:600 }
        
        /* Route Builder */
        #routeMap { height:500px; border-radius:8px; margin-bottom:16px; border:2px solid rgba(102,126,234,0.3) }
        .route-builder { display:grid; grid-template-columns:1.2fr 1fr; gap:20px; margin-bottom:20px }
        @media (max-width:1000px) { .route-builder { grid-template-columns:1fr } }
        
        .route-panel { background:#0f0f23; padding:18px; border-radius:10px; border:1px solid rgba(255,255,255,0.06) }
        .step-indicator { display:flex; gap:10px; margin-bottom:18px }
        .step { padding:8px 12px; border-radius:6px; font-size:12px; text-align:center; flex:1; background:#0d1117; color:#9aa4b2; font-weight:500 }
        .step.active { background:#667eea; color:#fff; box-shadow:0 0 12px rgba(102,126,234,0.4) }
        .step.done { background:#34d399; color:#fff }
        
        .instruction-box { background:rgba(102,126,234,0.1); padding:12px; border-radius:6px; border:1px solid rgba(102,126,234,0.2); margin-bottom:14px; font-size:13px; line-height:1.5 }
        .instruction-main { font-size:14px; font-weight:600; color:#667eea; margin-bottom:4px }
        .instruction-sub { color:#9aa4b2; margin-top:2px }
        .draw-mode-hint { margin-top:6px; font-size:11px; color:#9aa4b2 }
        .draw-mode-hint kbd {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 4px;
            padding: 1px 5px;
            font-family: monospace;
            font-size: 11px;
        }
        .stop-radius-wrap {
            margin-top: 8px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(102,126,234,0.22);
            background: rgba(102,126,234,0.06);
        }
        .stop-radius-head {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #c7d2fe;
            user-select: none;
        }
        .stop-radius-head input[type=checkbox] {
            width: 14px;
            height: 14px;
            accent-color: #667eea;
            cursor: pointer;
        }
        .stop-radius-head .value {
            margin-left: auto;
            font-size: 10px;
            color: #dbe3ff;
            border: 1px solid rgba(102,126,234,0.36);
            border-radius: 999px;
            padding: 2px 7px;
            background: rgba(102,126,234,0.18);
        }
        .stop-radius-controls {
            margin-top: 8px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }
        .stop-radius-controls.visible { display: flex; }
        .stop-radius-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stop-radius-row input[type=range] {
            flex: 1;
            min-width: 0;
        }
        .stop-radius-row .meter {
            min-width: 54px;
            text-align: right;
            font-size: 11px;
            color: #9aa4b2;
        }
        .stop-radius-row input[type=number] {
            flex: 1;
            min-width: 0;
            font-size: 12px;
            padding: 6px 8px;
        }
        .stop-radius-row button {
            padding: 6px 10px;
            font-size: 11px;
            border-radius: 8px;
        }
        
        .stops-list { max-height:450px; overflow-y:auto; background:#0d1117; border-radius:6px; padding:10px }
        .stop-item { padding:10px; background:#07101a; border-radius:6px; margin-bottom:8px; border-left:4px solid; display:flex; gap:8px; align-items:center; font-size:13px }
        .stop-item.start { border-left-color:#4CAF50; background:#0d1117 }
        .stop-item input { flex:1; background:#0f0f23; border:1px solid rgba(255,255,255,0.04); color:#e6eef8; padding:6px 8px; border-radius:4px }
        .stop-num { min-width:28px; text-align:center; color:#9aa4b2; font-weight:bold; font-size:12px }
        .stop-icon { font-size:16px }
        /* Unified icon styling */
        .icon { display:inline-block; font-size:14px; line-height:1; vertical-align:middle; opacity:0.9; margin-right:6px }
        .tab .icon { font-size:16px; opacity:0.85 }
        .field-label .icon { font-size:14px }
        .route-panel h3 .icon { font-size:15px }
        .stop-icon { font-size:13px }
        /* Map tiny markers (fixed pixel size, crisp) */
        .tiny-marker { width:8px; height:8px; border-radius:50%; display:inline-block; border:1px solid rgba(255,255,255,0.5) }
        .tiny-marker:hover { transform: none; }
        .tiny-start { width:10px; height:10px; background:#4CAF50 }
        .tiny-hostel { background:#9C27B0 }
        .tiny-class { background:#2196F3 }
        .tiny-stop { background:#667eea }
        .marker-wrapper { width:10px; height:10px }
        /* Remove default white background from DivIcons */
        .leaflet-div-icon { background: transparent !important; border: none !important; }
        
        .button-group { display:flex; gap:8px; margin-top:14px }
        .button-group button { flex:1 }
        
        .routes-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px; margin-top:12px }
        .route-card { background:#0f0f23; padding:12px; border-radius:10px; border-left:5px solid; border:1px solid rgba(255,255,255,0.06) }
        .route-badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; font-weight:600 }
        .badge-running { background:rgba(52,211,153,0.12); color:#34d399; border:1px solid rgba(52,211,153,0.25) }
        .badge-idle { background:rgba(255,154,162,0.1); color:#ff9aa2; border:1px solid rgba(255,154,162,0.25) }
        .route-name { font-weight:600; margin-bottom:4px }
        .route-info { font-size:12px; color:#9aa4b2; margin-bottom:8px }
        .route-actions { display:flex; gap:6px }
        .route-actions button { flex:1; font-size:12px; padding:6px }
        .perf-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:10px; margin-bottom:14px }
        .perf-card {
            background:#0f0f23;
            border:1px solid rgba(255,255,255,0.06);
            border-radius:10px;
            padding:12px;
        }
        .perf-k { font-size:11px; color:#9aa4b2; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.04em }
        .perf-v { font-size:16px; font-weight:600; color:#e6eef8 }
        .perf-v.small { font-size:13px; font-weight:500; color:#c8d2e0 }
        .perf-two-col { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:14px }
        @media (max-width:900px) { .perf-two-col { grid-template-columns:1fr; } }
        .audit-wrap {
            background:#0f0f23;
            border:1px solid rgba(255,255,255,0.06);
            border-radius:10px;
            padding:10px;
        }
        .audit-table-wrap { max-height:320px; overflow:auto; border-radius:8px; }
        #perfAuditTable { margin-top:0; font-size:12px; }
        #perfAuditTable td { font-size:12px; color:#c6d0df; }
        #perfAuditTable .status-ok { color:#34d399; font-weight:600; }
        #perfAuditTable .status-failed, #perfAuditTable .status-error { color:#ff7b8a; font-weight:600; }

        cursor-info { font-size:11px; color:#667eea; text-align:center; margin-top:8px; display:block }
    </style>
</head>
<body>
    <div class="panel">
        <div class="topbar">
            <div>
                <div style="font-weight:700; font-size:14px; color:#e6eef8">{{ institute_name | default('INSTITUTE') }} TRANSPORT SYSTEM</div>
                <h1>üõ£Ô∏è Route Builder</h1>
                <p class="subtitle">Create routes by clicking on the map - no coordinates needed!</p>
                <div class="controls" style="margin-top:8px">
                    <label class="field-label" for="totalTransportsInput">Total Transports</label>
                    <button id="decTotalTransports">‚àí</button>
                    <input id="totalTransportsInput" type="number" min="0" value="100" style="width:100px">
                    <button id="incTotalTransports">+</button>
                    <button id="saveTotalTransports" class="ok">Save</button>
                </div>
            </div>
            <div style="text-align:right">
                <a href="/" target="_blank" rel="noopener noreferrer" style="color:#9aa4b2; text-decoration:none; margin-right:12px">Student View</a>
                <a href="/driver" target="_blank" rel="noopener noreferrer" style="color:#9aa4b2; text-decoration:none; margin-right:12px">Driver View</a>
                <a href="/simulator" target="_blank" rel="noopener noreferrer" style="color:#9aa4b2; text-decoration:none; margin-right:12px">Simulator</a>
                <button onclick="showUsersSection()" style="background:#34d399;color:#042017;margin-right:12px;padding:8px 16px;border-radius:8px;border:none;cursor:pointer">Users</button>
                {% if admin_user %}
                    <span style="color:#9aa4b2; margin-right:8px">{{ admin_user }}</span>
                    <a href="/admin/logout" style="color:#ff9aa2; text-decoration:none">Logout</a>
                {% else %}
                    <a href="/admin/login" style="color:#9aa4b2; text-decoration:none">Admin Login</a>
                {% endif %}
            </div>
        </div>

        <div class="tabs">
            <div class="tab" data-tab="routes"><span class="icon">üó∫Ô∏è</span> Create Route</div>
            <div class="tab active" data-tab="buses"><span class="icon">üöå</span> Manage Transports</div>
            <div class="tab" data-tab="buildings"><span class="icon">üè†</span> Buildings</div>
            <div class="tab" data-tab="serverPerf"><span class="icon">‚ö°</span> Server Performance</div>
        </div>
        <div id="usersSection" style="display:none;background:#07101a;padding:18px;border-radius:8px;margin-bottom:18px">
            <h2 style="color:#34d399">All Users</h2>
            <div id="usersTable"></div>
            <h3 style="margin-top:16px;color:#e6eef8;font-size:16px">Manage Admins</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:center">
                <input id="adminUsername" placeholder="Username" style="min-width:160px">
                <div style="display:flex;gap:8px;align-items:center">
                    <input id="adminPassword" type="password" placeholder="Password" style="min-width:160px">
                    <button type="button" onclick="toggleVisibility('adminPassword', this)" style="margin-top:0;background:#667eea;color:#fff">Show</button>
                </div>
                <input id="adminPin" placeholder="Pin (456123)" style="min-width:140px">
                <button class="ok" onclick="addAdmin()">+ Add Admin</button>
            </div>
            <div id="adminsTable"></div>
            <button onclick="hideUsersSection()" style="margin-top:12px;background:#ff7b8a;color:#fff;padding:8px 16px;border-radius:8px;border:none;cursor:pointer">Close</button>
        </div>
        <script>
        function showUsersSection() {
            fetch('/admin/users').then(r=>r.json()).then(data=>{
                let html = '<table style="width:100%;margin-top:12px"><thead><tr><th>Type</th><th>Username</th><th>Password</th></tr></thead><tbody>';
                for(let user of data.users){
                    html += `<tr><td>${user.type}</td><td>${user.username}</td><td>${user.password}</td></tr>`;
                }
                html += '</tbody></table>';
                document.getElementById('usersTable').innerHTML = html;
                document.getElementById('usersSection').style.display = 'block';
            }).then(()=>{
                loadAdmins();
            });
        }
        function hideUsersSection(){
            document.getElementById('usersSection').style.display = 'none';
        }

        function loadAdmins(){
            fetch('/admin/admins').then(r=>r.json()).then(data=>{
                const admins = data.admins || [];
                let html = '<table style="width:100%;margin-top:8px"><thead><tr><th>Admin</th><th style="width:280px">Actions</th></tr></thead><tbody>';
                if(admins.length===0){
                    html += '<tr><td colspan="2" class="empty">No admins yet</td></tr>';
                } else {
                    for(let a of admins){
                        html += `<tr>
                            <td><strong>${a.username}</strong></td>
                            <td class="row-actions">
                                <button onclick="promptChangeAdminPassword('${a.username}')">Change Password</button>
                                <button class="danger" onclick="deleteAdmin('${a.username}')">Delete</button>
                            </td>
                        </tr>`;
                    }
                }
                html += '</tbody></table>';
                document.getElementById('adminsTable').innerHTML = html;
            });
        }

        function addAdmin(){
            const username = document.getElementById('adminUsername').value.trim();
            const password = document.getElementById('adminPassword').value.trim();
            const pin = document.getElementById('adminPin').value.trim();
            if(!username || !password || !pin){ alert('Enter username, password and pin'); return; }
            fetch('/admin/admins', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ username, password, pin })
            }).then(async r=>{
                if(!r.ok){ const e = await r.json(); alert(e.error||'Failed'); return; }
                document.getElementById('adminUsername').value='';
                document.getElementById('adminPassword').value='';
                document.getElementById('adminPin').value='';
                loadAdmins();
            });
        }

        function deleteAdmin(username){
            fetch(`/admin/admins/${encodeURIComponent(username)}`, { method:'DELETE' }).then(async r=>{
                if(!r.ok){ const e = await r.json(); alert(e.error||'Failed'); return; }
                loadAdmins();
            });
        }

        function promptChangeAdminPassword(username){
            const pwd = prompt(`New password for ${username}:`);
            if(pwd===null) return;
            const pin = prompt('Enter pin (456123):');
            if(pin===null) return;
            changeAdminPassword(username, pwd, pin);
        }

        function changeAdminPassword(username, password, pin){
            if(!password || !pin){ alert('Password and pin are required'); return; }
            fetch(`/admin/admins/${encodeURIComponent(username)}/password`, {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ password, pin })
            }).then(async r=>{
                if(!r.ok){ const e = await r.json(); alert(e.error||'Failed'); return; }
                alert('Password updated');
            });
        }
        function toggleVisibility(id, btn){
            const el = document.getElementById(id);
            if(!el) return;
            const isPwd = el.type === 'password';
            el.type = isPwd ? 'text' : 'password';
            if(btn) btn.textContent = isPwd ? 'Hide' : 'Show';
        }
        </script>
        <script>
        
        async function loadTotalTransports(){
            try{
                const res = await fetch('/api/metrics');
                const data = await res.json();
                const val = typeof data.total_transports === 'number' ? data.total_transports : 100;
                const input = document.getElementById('totalTransportsInput');
                if(input) input.value = val;
            }catch(e){ /* ignore */ }
        }
        function initTotalTransportControls(){
            const input = document.getElementById('totalTransportsInput');
            const dec = document.getElementById('decTotalTransports');
            const inc = document.getElementById('incTotalTransports');
            const save = document.getElementById('saveTotalTransports');
            if(dec) dec.addEventListener('click', ()=>{ const v = Math.max(0, parseInt(input.value||'0')-1); input.value = v; });
            if(inc) inc.addEventListener('click', ()=>{ const v = Math.max(0, parseInt(input.value||'0')+1); input.value = v; });
            if(save) save.addEventListener('click', async ()=>{
                const v = Math.max(0, parseInt(input.value||'0'));
                await fetch('/api/metrics', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ total_transports: v }) });
                alert('Saved');
            });
        }
        document.addEventListener('DOMContentLoaded', ()=>{ loadTotalTransports(); initTotalTransportControls(); });
        </script>

        <!-- ROUTES TAB -->
        <div id="routes" class="tab-content">
            <div class="route-builder">
                <!-- MAP SECTION -->
                <div>
                    <div class="field-label" style="margin-bottom:8px">üìç Click on map to add stops</div>
                    <div id="routeMap"></div>
                    <cursor-info id="cursorInfo">üëÜ Click on map | First click = Start Point | Next clicks = Stops</cursor-info>
                </div>
                
                <!-- CONTROLS -->
                <div>
                    <div class="route-panel">
                        <h3 style="margin:0 0 16px 0; font-size:15px">Route Details</h3>
                        
                        <!-- Step Indicator -->
                        <div class="step-indicator">
                            <div class="step active" id="step1">1. Start</div>
                            <div class="step" id="step2">2. Stops</div>
                            <div class="step" id="step3">3. Save</div>
                        </div>

                        <!-- Instructions -->
                        <div class="instruction-box">
                            <div class="instruction-main" id="mainInstruction">Step 1: Click on map to set START point</div>
                            <div class="instruction-sub" id="subInstruction">First click anywhere on the map</div>
                        </div>

                        <!-- Route Name -->
                        <div class="field-group">
                            <label class="field-label">Route Name</label>
                            <input id="routeName" placeholder="e.g. North Campus Loop" style="width:100%">
                        </div>

                        <!-- Color -->
                        <div class="field-group">
                            <label class="field-label">Route Color</label>
                            <select id="routeColor" style="width:100%">
                                <option value="#FF5722">üî¥ Red-Orange</option>
                                <option value="#2196F3">üîµ Blue</option>
                                <option value="#4CAF50">üü¢ Green</option>
                                <option value="#FF9800">üü† Orange</option>
                                <option value="#9C27B0">üü£ Purple</option>
                                <option value="#00BCD4">üî∑ Cyan</option>
                                <option value="#E91E63">üíó Pink</option>
                                <option value="#FFEB3B">üü° Yellow</option>
                            </select>
                        </div>

                        <div class="field-group">
                            <label class="field-label">Draw Mode</label>
                            <select id="drawMode" style="width:100%">
                                <option value="curve" selected>Curve (3+ points)</option>
                                <option value="straight">Straight (start + end)</option>
                                <option value="freehand">Freehand (drag path)</option>
                            </select>
                            <div class="draw-mode-hint">Press <kbd>Esc</kbd> to finish drawing and lock end stop.</div>
                        </div>

                        <div class="field-group stop-radius-wrap">
                            <label class="stop-radius-head">
                                <input type="checkbox" id="showStopRadius">
                                <span>Show Stop Radius Overlay</span>
                                <span class="value" id="stopRadiusValue">80 m</span>
                            </label>
                            <div class="stop-radius-controls" id="stopRadiusControls">
                                <div class="stop-radius-row">
                                    <input type="range" id="stopRadiusSlider" min="10" max="300" step="1" value="80">
                                    <span class="meter" id="stopRadiusSliderValue">80 m</span>
                                </div>
                                <div class="stop-radius-row">
                                    <input type="number" id="stopRadiusCustom" min="1" step="1" placeholder="Custom meters (no limit)">
                                    <button type="button" id="applyStopRadiusBtn">Apply</button>
                                </div>
                            </div>
                        </div>

                        <!-- Stops List -->
                        <div class="field-group">
                            <label class="field-label">Stops (<span id="stopCount">0</span>)</label>
                            <div class="stops-list" id="stopsList"></div>
                        </div>

                        <!-- Buttons -->
                        <div class="button-group">
                            <button id="clearMapBtn" class="danger" style="background:rgba(255,123,138,0.05)">üóëÔ∏è Clear</button>
                            <button id="saveRouteBtn" class="ok" style="background:rgba(52,211,153,0.1)">üíæ Save Route</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EXISTING ROUTES -->
            <h3 style="margin-top:28px; margin-bottom:14px; font-size:16px">üìö Your Routes</h3>
            <div class="routes-grid" id="routesList"></div>
        </div>

        <!-- TRANSPORTS TAB -->
        <div id="buses" class="tab-content active">
            <div class="controls">
                <input id="newBusNum" placeholder="Transport number (e.g. 21)" style="width:140px">
                <input id="newLat" placeholder="Latitude" style="width:160px">
                <input id="newLng" placeholder="Longitude" style="width:160px">
                <button id="addBtn" class="ok">Add Transport</button>
                <div style="flex:1"></div>
                <button id="refreshBtn">Refresh</button>
                <button id="clearAllBtn" class="danger">Clear All</button>
            </div>
            <div id="busList">
                <div class="empty">Loading transports...</div>
            </div>
        </div>

        <!-- BUILDINGS TAB -->
        <div id="buildings" class="tab-content">
            <div style="display:grid; grid-template-columns:1.2fr 1fr; gap:20px">
                <!-- MAP -->
                <div>
                    <div class="field-label" style="margin-bottom:8px"><span class="icon">üìç</span> Click to place building</div>
                    <div id="buildingsMap" style="height:500px; border-radius:8px; margin-bottom:16px; border:2px solid rgba(102,126,234,0.3)"></div>
                </div>

                <!-- CONTROLS -->
                <div>
                    <!-- HOSTELS -->
                    <div class="route-panel" style="margin-bottom:20px">
                        <h3 style="margin:0 0 12px 0; font-size:14px"><span class="icon">üè®</span> Add Hostel</h3>
                        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px">
                            <input id="hostelName" placeholder="Name (e.g. Block A)" style="width:100%; font-size:12px; padding:6px 8px">
                            <input id="hostelCapacity" placeholder="Capacity" style="width:100%; font-size:12px; padding:6px 8px" value="100">
                            <button id="addHostelBtn" class="ok" style="background:rgba(52,211,153,0.1); font-size:12px; padding:6px">+ Place on Map</button>
                        </div>
                        <div class="field-label">Hostels (<span id="hostelCount">0</span>)</div>
                        <div id="hostelsList" style="max-height:200px; overflow-y:auto; background:#0d1117; border-radius:6px; padding:8px">
                            <div class="empty" style="font-size:12px; padding:10px">Click map to add</div>
                        </div>
                    </div>

                    <!-- CLASSES -->
                    <div class="route-panel">
                        <h3 style="margin:0 0 12px 0; font-size:14px"><span class="icon">üìö</span> Add Class</h3>
                        <div style="display:flex; flex-direction:column; gap:8px; margin-bottom:12px">
                            <input id="className" placeholder="Name (e.g. A-101)" style="width:100%; font-size:12px; padding:6px 8px">
                            <input id="classDept" placeholder="Department" style="width:100%; font-size:12px; padding:6px 8px">
                            <button id="addClassBtn" class="ok" style="background:rgba(52,211,153,0.1); font-size:12px; padding:6px">+ Place on Map</button>
                        </div>
                        <div class="field-label">Classes (<span id="classCount">0</span>)</div>
                        <div id="classesList" style="max-height:200px; overflow-y:auto; background:#0d1117; border-radius:6px; padding:8px">
                            <div class="empty" style="font-size:12px; padding:10px">Click map to add</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SERVER PERFORMANCE TAB -->
        <div id="serverPerf" class="tab-content">
            <div class="controls" style="justify-content:space-between; margin-bottom:14px">
                <div class="small">Live server telemetry and admin audit logs</div>
                <div>
                    <button id="perfExportMdBtn">Export .md</button>
                    <button id="perfExportTxtBtn">Export .txt</button>
                    <button id="perfRefreshBtn">Refresh</button>
                </div>
            </div>

            <div class="perf-grid">
                <div class="perf-card">
                    <div class="perf-k">Uptime</div>
                    <div class="perf-v" id="perfUptime">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-k">RAM (Process / System)</div>
                    <div class="perf-v" id="perfRam">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-k">CPU (Process)</div>
                    <div class="perf-v" id="perfCpu">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-k">Bandwidth In</div>
                    <div class="perf-v" id="perfBandwidthIn">--</div>
                    <div class="perf-v small" id="perfBandwidthInRate">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-k">Bandwidth Out</div>
                    <div class="perf-v" id="perfBandwidthOut">--</div>
                    <div class="perf-v small" id="perfBandwidthOutRate">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-k">Requests</div>
                    <div class="perf-v" id="perfRequests">--</div>
                </div>
                <div class="perf-card">
                    <div class="perf-k">SSE Clients</div>
                    <div class="perf-v" id="perfSseClients">--</div>
                </div>
            </div>

            <div class="perf-two-col">
                <div class="audit-wrap">
                    <h3 style="margin:0 0 10px 0; font-size:14px">Admin Login Info</h3>
                    <div class="perf-grid" style="margin-bottom:0">
                        <div class="perf-card">
                            <div class="perf-k">Current Admin</div>
                            <div class="perf-v" id="perfCurrentAdmin">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Admin Accounts</div>
                            <div class="perf-v" id="perfAdminCount">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Successful Logins</div>
                            <div class="perf-v" id="perfLoginSuccess">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Failed Logins</div>
                            <div class="perf-v" id="perfLoginFailed">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Last Successful Login</div>
                            <div class="perf-v small" id="perfLastLoginSuccess">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Last Failed Login</div>
                            <div class="perf-v small" id="perfLastLoginFailed">--</div>
                        </div>
                    </div>
                </div>
                <div class="audit-wrap">
                    <h3 style="margin:0 0 10px 0; font-size:14px">Server Snapshot</h3>
                    <div class="perf-grid" style="margin-bottom:0">
                        <div class="perf-card">
                            <div class="perf-k">Transports</div>
                            <div class="perf-v" id="perfBusesCount">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Routes</div>
                            <div class="perf-v" id="perfRoutesCount">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Hostels</div>
                            <div class="perf-v" id="perfHostelsCount">--</div>
                        </div>
                        <div class="perf-card">
                            <div class="perf-k">Classes</div>
                            <div class="perf-v" id="perfClassesCount">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="audit-wrap">
                <h3 style="margin:0 0 10px 0; font-size:14px">Audit Log</h3>
                <div class="audit-table-wrap">
                    <table id="perfAuditTable">
                        <thead>
                            <tr>
                                <th>Time (UTC)</th>
                                <th>Event</th>
                                <th>User</th>
                                <th>Status</th>
                                <th>IP</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="perfAuditRows">
                            <tr><td colspan="6" class="empty">No audit logs yet</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentWaypoints = [];
        let currentStops = [];
        let editingRouteId = null;
        let routeMap = null;
        let routeMarkers = [];
        let routeLine = null;
        let stopRadiusLayers = [];
        let mapMode = 'start'; // 'start' or 'stops'
        let drawMode = 'curve'; // 'straight' | 'curve' | 'freehand'
        let isFreehandDrawing = false;
        let freehandLastPoint = null;
        let suppressNextClick = false;
        const FREEHAND_MIN_POINT_M = 8;
        let stopRadiusVisible = false;
        let stopRadiusMeters = 80;
        let renderQueued = false;
        let renderToken = 0;
        
        let buildingsMap = null;
        let buildingMarkers = {};
        let pendingHostelName = null;
        let pendingHostelCapacity = null;
        let pendingClassName = null;
        let pendingClassDept = null;
        let perfAutoRefreshId = null;

        function isTabActive(tabId) {
            const el = document.getElementById(tabId);
            return !!(el && el.classList.contains('active'));
        }

        function setText(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = (value === null || value === undefined || value === '') ? '--' : String(value);
        }

        function formatBytes(bytes) {
            const v = Number(bytes) || 0;
            if (v < 1024) return `${v} B`;
            if (v < 1024 * 1024) return `${(v / 1024).toFixed(2)} KB`;
            if (v < 1024 * 1024 * 1024) return `${(v / (1024 * 1024)).toFixed(2)} MB`;
            return `${(v / (1024 * 1024 * 1024)).toFixed(2)} GB`;
        }

        function formatKbps(v) {
            const n = Number(v) || 0;
            return `${n.toFixed(2)} kbps`;
        }

        function formatPercent(v) {
            const n = Number(v);
            if (!Number.isFinite(n)) return '--';
            return `${n.toFixed(1)}%`;
        }

        function formatUptime(seconds) {
            const sec = Math.max(0, Number(seconds) || 0);
            const d = Math.floor(sec / 86400);
            const h = Math.floor((sec % 86400) / 3600);
            const m = Math.floor((sec % 3600) / 60);
            const s = sec % 60;
            if (d > 0) return `${d}d ${h}h ${m}m ${s}s`;
            if (h > 0) return `${h}h ${m}m ${s}s`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        function formatIsoUtc(iso) {
            if (!iso) return '--';
            const d = new Date(iso);
            if (isNaN(d.getTime())) return iso;
            const pad = (v) => String(v).padStart(2, '0');
            const dd = pad(d.getUTCDate());
            const mm = pad(d.getUTCMonth() + 1);
            const yy = String(d.getUTCFullYear()).slice(-2);
            const hh = pad(d.getUTCHours());
            const min = pad(d.getUTCMinutes());
            const ss = pad(d.getUTCSeconds());
            return `${dd}/${mm}/${yy} ${hh}/${min}/${ss}`;
        }

        function renderPerfAuditRows(logs) {
            const tbody = document.getElementById('perfAuditRows');
            if (!tbody) return;
            const rows = Array.isArray(logs) ? logs : [];
            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty">No audit logs yet</td></tr>';
                return;
            }
            tbody.innerHTML = rows.map((entry) => {
                const status = String(entry && entry.status ? entry.status : '').toLowerCase();
                const statusClass = (status === 'success' || status === 'ok') ? 'status-ok' : `status-${status || 'failed'}`;
                return `<tr>
                    <td>${formatIsoUtc(entry.ts)}</td>
                    <td>${entry.event || '--'}</td>
                    <td>${entry.username || '--'}</td>
                    <td class="${statusClass}">${entry.status || '--'}</td>
                    <td>${entry.ip || '--'}</td>
                    <td>${entry.details || '--'}</td>
                </tr>`;
            }).join('');
        }

        async function loadServerPerformance() {
            try {
                const res = await fetch('/admin/performance', { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                setText('perfUptime', formatUptime(data.uptime_sec));
                const processRam = data.memory && data.memory.process_rss_mb != null ? `${data.memory.process_rss_mb} MB` : '--';
                const systemRam = data.memory && data.memory.system_total_mb != null ? `${data.memory.system_total_mb} MB` : '--';
                const systemRamUsed = data.memory && data.memory.system_used_mb != null ? `${data.memory.system_used_mb} MB` : null;
                setText('perfRam', systemRamUsed ? `${processRam} / ${systemRamUsed} of ${systemRam}` : `${processRam} / ${systemRam}`);
                const cpuPercent = data.cpu && data.cpu.process_percent != null ? formatPercent(data.cpu.process_percent) : '--';
                const cpuCores = data.cpu && data.cpu.cores != null ? ` (${data.cpu.cores} cores)` : '';
                setText('perfCpu', `${cpuPercent}${cpuCores}`);
                setText('perfBandwidthIn', formatBytes(data.bandwidth && data.bandwidth.in_bytes));
                setText('perfBandwidthOut', formatBytes(data.bandwidth && data.bandwidth.out_bytes));
                setText('perfBandwidthInRate', formatKbps(data.bandwidth && data.bandwidth.avg_in_kbps));
                setText('perfBandwidthOutRate', formatKbps(data.bandwidth && data.bandwidth.avg_out_kbps));
                setText('perfRequests', data.requests_total);
                setText('perfSseClients', data.sse_clients);
                setText('perfCurrentAdmin', data.admin && data.admin.current_admin);
                setText('perfAdminCount', data.admin && data.admin.admins_count);
                setText('perfLoginSuccess', data.admin && data.admin.successful_logins);
                setText('perfLoginFailed', data.admin && data.admin.failed_logins);
                setText('perfLastLoginSuccess', formatIsoUtc(data.admin && data.admin.last_success_login));
                setText('perfLastLoginFailed', formatIsoUtc(data.admin && data.admin.last_failed_login));
                setText('perfBusesCount', data.buses_count);
                setText('perfRoutesCount', data.routes_count);
                setText('perfHostelsCount', data.hostels_count);
                setText('perfClassesCount', data.classes_count);
                renderPerfAuditRows(data.audit_logs);
            } catch (e) {
                setText('perfUptime', 'Failed to load');
                setText('perfCpu', '--');
            }
        }

        async function downloadPerfExport(format) {
            const fmt = (format === 'txt') ? 'txt' : 'md';
            try {
                const res = await fetch(`/admin/performance/export?format=${fmt}`, { cache: 'no-store' });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const stamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.href = url;
                a.download = `admin-audit-${stamp}.${fmt}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (e) {
                alert(`Export failed (${fmt.toUpperCase()})`);
            }
        }

        function startPerfAutoRefresh() {
            stopPerfAutoRefresh();
            loadServerPerformance();
            perfAutoRefreshId = setInterval(() => {
                if (!isTabActive('serverPerf') || document.hidden) return;
                loadServerPerformance();
            }, 5000);
        }

        function stopPerfAutoRefresh() {
            if (perfAutoRefreshId) {
                try { clearInterval(perfAutoRefreshId); } catch (e) {}
                perfAutoRefreshId = null;
            }
        }

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.getAttribute('data-tab')).classList.add('active');
                if (tab.getAttribute('data-tab') === 'routes') {
                    setTimeout(initRouteMap, 100);
                    loadRoutes();
                    stopBusesAutoRefresh();
                    stopPerfAutoRefresh();
                } else if (tab.getAttribute('data-tab') === 'buildings') {
                    setTimeout(initBuildingsMap, 100);
                    loadHostels();
                    loadClasses();
                    stopBusesAutoRefresh();
                    stopPerfAutoRefresh();
                } else if (tab.getAttribute('data-tab') === 'buses') {
                    startBusesAutoRefresh();
                    stopPerfAutoRefresh();
                } else if (tab.getAttribute('data-tab') === 'serverPerf') {
                    stopBusesAutoRefresh();
                    startPerfAutoRefresh();
                }
            });
        });

        // ==== ROUTE MAP ====
        function pointDistanceMeters(a, b) {
            const dLat = (b[0] - a[0]) * Math.PI / 180;
            const dLng = (b[1] - a[1]) * Math.PI / 180;
            const x = dLng * Math.cos(((a[0] + b[0]) * 0.5) * Math.PI / 180);
            return 6371000 * Math.sqrt((dLat * dLat) + (x * x));
        }

        function getNamedStopCount() {
            let count = 0;
            for (let i = 1; i < currentStops.length; i++) {
                if (currentStops[i] && String(currentStops[i]).trim()) count++;
            }
            return count;
        }

        function nextStopName() {
            return `Stop ${getNamedStopCount() + 1}`;
        }

        function ensureStopsArraySize() {
            while (currentStops.length < currentWaypoints.length) currentStops.push('');
            if (currentStops.length > currentWaypoints.length) currentStops.length = currentWaypoints.length;
            if (currentWaypoints.length > 0 && (!currentStops[0] || !String(currentStops[0]).trim())) {
                currentStops[0] = 'START';
            }
        }

        function addOrFixStopName(idx) {
            if (idx < 0 || idx >= currentWaypoints.length) return;
            if (idx === 0) {
                currentStops[idx] = 'START';
                return;
            }
            const existing = currentStops[idx] ? String(currentStops[idx]).trim() : '';
            currentStops[idx] = existing || nextStopName();
        }

        function getStopListEntries() {
            const entries = [];
            for (let idx = 0; idx < currentWaypoints.length; idx++) {
                const isStart = idx === 0;
                const isEnd = idx === currentWaypoints.length - 1;
                const name = currentStops[idx] ? String(currentStops[idx]).trim() : '';
                if (isStart || name || (drawMode === 'freehand' && isEnd)) {
                    entries.push({ idx, wp: currentWaypoints[idx], isStart, isEnd });
                }
            }
            return entries;
        }

        function scheduleRouteRender() {
            if (renderQueued) return;
            renderQueued = true;
            requestAnimationFrame(() => {
                renderQueued = false;
                renderMapWaypoints();
                renderStopsList();
            });
        }

        function updateCursorInfo() {
            const el = document.getElementById('cursorInfo');
            if (!el) return;
            if (drawMode === 'straight') {
                el.textContent = 'Straight mode: click START, then click END (single segment).';
                return;
            }
            if (drawMode === 'curve') {
                el.textContent = 'Curve mode: click 3+ points. Press Esc to finish.';
                return;
            }
            if (isFreehandDrawing) {
                el.textContent = 'Freehand mode: drag to draw. Release mouse or press Esc to finish.';
                return;
            }
            el.textContent = 'Freehand mode: hold mouse and drag to draw path. Press Esc to finish.';
        }

        function formatStopRadiusText(meters) {
            const v = Math.max(1, Math.round(Number(meters) || 0));
            return `${v} m`;
        }

        function clearStopRadiusLayers() {
            if (!routeMap || !stopRadiusLayers.length) return;
            stopRadiusLayers.forEach((layer) => {
                try { routeMap.removeLayer(layer); } catch (e) {}
            });
            stopRadiusLayers = [];
        }

        function drawStopRadiusLayers(entries) {
            clearStopRadiusLayers();
            if (!routeMap || !stopRadiusVisible || !entries || !entries.length) return;
            const color = document.getElementById('routeColor').value || '#667eea';
            entries.forEach(({ wp, isStart }) => {
                if (!wp || wp.length < 2) return;
                const layer = L.circle([wp[0], wp[1]], {
                    radius: stopRadiusMeters,
                    color: isStart ? '#4CAF50' : color,
                    weight: 1,
                    opacity: 0.42,
                    fillColor: isStart ? '#4CAF50' : color,
                    fillOpacity: 0.12,
                    interactive: false
                }).addTo(routeMap);
                stopRadiusLayers.push(layer);
            });
        }

        function refreshStopRadiusUi() {
            const showToggle = document.getElementById('showStopRadius');
            const controls = document.getElementById('stopRadiusControls');
            const valueTag = document.getElementById('stopRadiusValue');
            const slider = document.getElementById('stopRadiusSlider');
            const sliderValue = document.getElementById('stopRadiusSliderValue');
            if (!showToggle || !controls || !valueTag || !slider || !sliderValue) return;

            showToggle.checked = !!stopRadiusVisible;
            controls.classList.toggle('visible', !!stopRadiusVisible);
            valueTag.textContent = formatStopRadiusText(stopRadiusMeters);
            sliderValue.textContent = formatStopRadiusText(stopRadiusMeters);

            const max = Number(slider.max || 300);
            const safeForSlider = Math.min(max, Math.max(Number(slider.min || 10), stopRadiusMeters));
            slider.value = String(safeForSlider);
        }

        function applyStopRadiusValue(rawValue) {
            const parsed = Number(rawValue);
            if (!isFinite(parsed) || parsed <= 0) return false;
            stopRadiusMeters = Math.round(parsed);
            refreshStopRadiusUi();
            drawStopRadiusLayers(getStopListEntries());
            return true;
        }

        function initStopRadiusControls() {
            const showToggle = document.getElementById('showStopRadius');
            const slider = document.getElementById('stopRadiusSlider');
            const customInput = document.getElementById('stopRadiusCustom');
            const applyBtn = document.getElementById('applyStopRadiusBtn');
            if (!showToggle || !slider || !customInput || !applyBtn) return;
            if (showToggle.dataset.bound === '1') return;

            showToggle.dataset.bound = '1';
            showToggle.addEventListener('change', () => {
                stopRadiusVisible = !!showToggle.checked;
                refreshStopRadiusUi();
                drawStopRadiusLayers(getStopListEntries());
            });

            slider.addEventListener('input', () => {
                applyStopRadiusValue(slider.value);
            });

            const applyCustom = () => {
                if (!customInput.value.trim()) return;
                const ok = applyStopRadiusValue(customInput.value.trim());
                if (ok) customInput.value = '';
            };
            applyBtn.addEventListener('click', applyCustom);
            customInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') applyCustom();
            });

            refreshStopRadiusUi();
        }

        function finalizeRouteCreation() {
            if (currentWaypoints.length < 2) return;
            ensureStopsArraySize();
            addOrFixStopName(currentWaypoints.length - 1);
            mapMode = 'stops';
            updateSteps();
            updateInstructions();
            scheduleRouteRender();
        }

        function resetRouteBuilderState() {
            currentWaypoints = [];
            currentStops = [];
            mapMode = 'start';
            isFreehandDrawing = false;
            freehandLastPoint = null;
            suppressNextClick = false;
            if (routeMap && routeMap.dragging) {
                try { routeMap.dragging.enable(); } catch (e) {}
            }
            updateSteps();
            updateInstructions();
            updateCursorInfo();
            renderMapWaypoints();
            renderStopsList();
        }

        function handleRouteMapClick(lat, lng) {
            if (drawMode === 'straight') {
                if (currentWaypoints.length === 0) {
                    addWaypointFromMap(lat, lng, { asStop: true });
                } else if (currentWaypoints.length === 1) {
                    addWaypointFromMap(lat, lng, { asStop: true });
                    finalizeRouteCreation();
                } else {
                    currentWaypoints = [currentWaypoints[0], [lat, lng]];
                    currentStops = [currentStops[0] || 'START', currentStops[1] || 'Stop 1'];
                    ensureStopsArraySize();
                    finalizeRouteCreation();
                }
                return;
            }
            if (drawMode === 'curve') {
                addWaypointFromMap(lat, lng, { asStop: true });
            }
        }

        function startFreehand(lat, lng) {
            if (drawMode !== 'freehand') return;
            if (currentWaypoints.length === 0) {
                addWaypointFromMap(lat, lng, { asStop: true });
            } else {
                const last = currentWaypoints[currentWaypoints.length - 1];
                if (!last || pointDistanceMeters(last, [lat, lng]) > FREEHAND_MIN_POINT_M) {
                    addWaypointFromMap(lat, lng, { asStop: false });
                }
            }
            isFreehandDrawing = true;
            freehandLastPoint = [lat, lng];
            suppressNextClick = true;
            if (routeMap && routeMap.dragging) {
                try { routeMap.dragging.disable(); } catch (e) {}
            }
            updateInstructions();
        }

        function extendFreehand(lat, lng) {
            if (!isFreehandDrawing || drawMode !== 'freehand') return;
            if (!freehandLastPoint || pointDistanceMeters(freehandLastPoint, [lat, lng]) >= FREEHAND_MIN_POINT_M) {
                addWaypointFromMap(lat, lng, { asStop: false });
                freehandLastPoint = [lat, lng];
            }
        }

        function stopFreehand(lat, lng) {
            if (!isFreehandDrawing) return;
            isFreehandDrawing = false;
            if (routeMap && routeMap.dragging) {
                try { routeMap.dragging.enable(); } catch (e) {}
            }
            if (typeof lat === 'number' && typeof lng === 'number') {
                const last = currentWaypoints[currentWaypoints.length - 1];
                if (!last || pointDistanceMeters(last, [lat, lng]) > 1) {
                    addWaypointFromMap(lat, lng, { asStop: false });
                }
            }
            freehandLastPoint = null;
            finalizeRouteCreation();
            updateInstructions();
        }

        function initRouteMap() {
            if (routeMap) return;
            const bounds = [[20.339920625677212, 85.7964659296332], [20.37210882553945, 85.83388810783698]];
            routeMap = L.map('routeMap', { maxBounds: bounds, minZoom: 14 }).setView([20.3549, 85.8161], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(routeMap);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '',
                maxZoom: 19
            }).addTo(routeMap);

            routeMap.on('click', (e) => {
                if (suppressNextClick) { suppressNextClick = false; return; }
                if (drawMode === 'freehand') return;
                handleRouteMapClick(e.latlng.lat, e.latlng.lng);
            });

            routeMap.on('mousedown', (e) => {
                if (drawMode !== 'freehand') return;
                startFreehand(e.latlng.lat, e.latlng.lng);
            });
            routeMap.on('mousemove', (e) => {
                if (drawMode !== 'freehand') return;
                extendFreehand(e.latlng.lat, e.latlng.lng);
            });
            routeMap.on('mouseup', (e) => {
                if (drawMode !== 'freehand') return;
                stopFreehand(e.latlng.lat, e.latlng.lng);
            });
            routeMap.on('mouseout', () => {
                if (drawMode !== 'freehand') return;
                if (isFreehandDrawing) stopFreehand();
            });

            const modeSel = document.getElementById('drawMode');
            if (modeSel) {
                drawMode = modeSel.value || 'curve';
                modeSel.addEventListener('change', () => {
                    drawMode = modeSel.value || 'curve';
                    if (drawMode !== 'freehand' && isFreehandDrawing) stopFreehand();
                    if (drawMode === 'straight' && currentWaypoints.length > 2) {
                        const end = currentWaypoints[currentWaypoints.length - 1];
                        currentWaypoints = [currentWaypoints[0], end];
                        currentStops = [currentStops[0] || 'START', currentStops[currentStops.length - 1] || 'Stop 1'];
                        ensureStopsArraySize();
                        finalizeRouteCreation();
                    } else {
                        updateInstructions();
                        scheduleRouteRender();
                    }
                });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key !== 'Escape') return;
                const routesTab = document.getElementById('routes');
                if (!routesTab || !routesTab.classList.contains('active')) return;
                if (drawMode === 'freehand' && isFreehandDrawing) {
                    stopFreehand();
                } else {
                    finalizeRouteCreation();
                }
            });

            initStopRadiusControls();
            updateSteps();
            updateInstructions();
            renderStopsList();
        }

        function addWaypointFromMap(lat, lng, opts = {}) {
            const asStop = opts.asStop !== false;
            currentWaypoints.push([lat, lng]);
            currentStops.push('');
            ensureStopsArraySize();
            if (currentWaypoints.length === 1) {
                mapMode = 'stops';
                currentStops[0] = 'START';
            } else if (asStop) {
                addOrFixStopName(currentWaypoints.length - 1);
            }
            updateSteps();
            updateInstructions();
            scheduleRouteRender();
        }

        function updateSteps() {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            if (!step1 || !step2 || !step3) return;

            step1.classList.remove('active', 'done');
            step2.classList.remove('active', 'done');
            step3.classList.remove('active', 'done');

            if (currentWaypoints.length === 0) {
                step1.classList.add('active');
                return;
            }
            step1.classList.add('done');
            step2.classList.add('active');
            if (currentWaypoints.length >= 2) step3.classList.add('active');
        }

        function updateInstructions() {
            const stopsCount = getNamedStopCount();
            let main = 'Step 1: Click on map to set START point';
            let sub = 'First click anywhere on the map';

            if (mapMode !== 'start') {
                main = 'Step 2: Build route path';
                if (drawMode === 'straight') {
                    sub = (currentWaypoints.length < 2)
                        ? 'Click one END point to complete straight route.'
                        : 'Straight route complete. Click Save Route.';
                } else if (drawMode === 'curve') {
                    sub = `Add 3+ points for bends. Press Esc to finish. Stops: ${stopsCount}`;
                } else {
                    sub = isFreehandDrawing
                        ? 'Drawing freehand... release mouse or press Esc to finalize endpoint stop.'
                        : `Drag to draw freehand path. Press Esc to finish. Stops: ${stopsCount}`;
                }
            }

            document.getElementById('mainInstruction').textContent = main;
            document.getElementById('subInstruction').textContent = sub;
            updateCursorInfo();
        }
        function renderMapWaypoints() {
            if (!routeMap) return;
            const color = document.getElementById('routeColor').value;

            routeMarkers.forEach(m => {
                try { routeMap.removeLayer(m); } catch (e) {}
            });
            routeMarkers = [];

            if (routeLine) {
                try { routeMap.removeLayer(routeLine); } catch (e) {}
                routeLine = null;
            }

            const stopEntries = getStopListEntries();
            stopEntries.forEach(({ idx, wp, isStart }) => {
                const bg = isStart ? '#4CAF50' : color;
                const html = isStart
                    ? '<span class="tiny-marker tiny-start"></span>'
                    : `<span class="tiny-marker" style="background:${bg}"></span>`;
                const icon = L.divIcon({ className: 'marker-wrapper', html: html, iconSize: [10, 10], iconAnchor: [5, 5] });
                const marker = L.marker([wp[0], wp[1]], { icon }).addTo(routeMap);
                const label = (currentStops[idx] && String(currentStops[idx]).trim())
                    ? String(currentStops[idx]).trim()
                    : (isStart ? 'START' : `Stop ${idx}`);
                marker.bindPopup(`<b>${label}</b><br>${wp[0].toFixed(4)}, ${wp[1].toFixed(4)}`);
                routeMarkers.push(marker);
            });

            if (currentWaypoints.length > 1) {
                routeLine = L.polyline(currentWaypoints, {
                    color: color,
                    weight: 2.5,
                    opacity: 0.8
                }).addTo(routeMap);
            }

            drawStopRadiusLayers(stopEntries);
        }
        async function getOSRMRoute(waypoints) {
            try {
                if (waypoints.length < 2) return waypoints;
                
                // Format: lon,lat;lon,lat...
                const coords = waypoints.map(wp => `${wp[1]},${wp[0]}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/driving/${coords}?geometries=geojson`;
                
                const res = await fetch(url);
                const data = await res.json();
                
                if (data.routes && data.routes[0]) {
                    // Convert GeoJSON coords (lon,lat) to Leaflet format (lat,lon)
                    return data.routes[0].geometry.coordinates.map(c => [c[1], c[0]]);
                }
                return waypoints;
            } catch(e) {
                console.error('OSRM error:', e);
                return waypoints;
            }
        }

        function renderStopsList() {
            const list = document.getElementById('stopsList');
            const entries = getStopListEntries();
            document.getElementById('stopCount').textContent = entries.length;

            if (entries.length === 0) {
                list.innerHTML = '<div style="text-align:center; color:#666; padding:20px; font-size:12px">No stops yet - click map to start</div>';
                return;
            }

            list.innerHTML = '';
            entries.forEach(({ idx }) => {
                const isStart = idx === 0;
                const fallback = isStart ? 'START' : `Stop ${idx}`;
                const value = (currentStops[idx] && String(currentStops[idx]).trim()) ? currentStops[idx] : fallback;

                const item = document.createElement('div');
                item.className = `stop-item ${isStart ? 'start' : ''}`;
                item.style.borderLeftColor = isStart ? '#4CAF50' : document.getElementById('routeColor').value;

                item.innerHTML = `
                    <div class="stop-icon">${isStart ? 'S' : 'P'}</div>
                    <input type="text" placeholder="${fallback}" value="${value}" readonly style="cursor:pointer" title="Click to edit">
                    <button class="danger" style="padding:4px 6px; font-size:11px" onclick="removeMapWaypoint(${idx})">x</button>
                `;

                const input = item.querySelector('input');
                input.addEventListener('click', () => {
                    input.removeAttribute('readonly');
                    input.style.cursor = 'text';
                    input.focus();
                });
                input.addEventListener('blur', () => {
                    currentStops[idx] = input.value || fallback;
                    input.setAttribute('readonly', '');
                    input.style.cursor = 'pointer';
                    renderMapWaypoints();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') input.blur();
                });

                list.appendChild(item);
            });
        }

        window.removeMapWaypoint = (idx) => {
            if (idx === 0 && currentWaypoints.length > 1) {
                alert('Cannot remove START point');
                return;
            }
            if (idx < 0 || idx >= currentWaypoints.length) return;

            currentWaypoints.splice(idx, 1);
            currentStops.splice(idx, 1);
            ensureStopsArraySize();
            if (currentWaypoints.length === 0) mapMode = 'start';
            if (drawMode === 'freehand' && currentWaypoints.length >= 2) {
                addOrFixStopName(currentWaypoints.length - 1);
            }
            updateSteps();
            updateInstructions();
            scheduleRouteRender();
        };

        document.getElementById('clearMapBtn').addEventListener('click', () => {
            if (currentWaypoints.length > 0 && !confirm('Clear all stops?')) return;
            resetRouteBuilderState();
        });

        document.getElementById('routeColor').addEventListener('change', () => {
            renderMapWaypoints();
        });

        document.getElementById('saveRouteBtn').addEventListener('click', async () => {
            const name = document.getElementById('routeName').value.trim();
            const color = document.getElementById('routeColor').value;
            
            if (!name) { alert('Enter route name'); return; }
            if (currentWaypoints.length < 2) { alert('Add at least START + END'); return; }
            if (drawMode === 'straight' && currentWaypoints.length !== 2) {
                alert('Straight mode needs exactly 2 points: start and end.');
                return;
            }
            if (drawMode === 'curve' && currentWaypoints.length < 3) {
                alert('Curve mode needs at least 3 points.');
                return;
            }
            finalizeRouteCreation();
            ensureStopsArraySize();
            
            const route = {
                id: editingRouteId || `route_${Date.now()}`,
                name: name,
                waypoints: currentWaypoints,
                stops: currentStops,
                color: color
            };
            
            const res = await fetch('/api/route', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify(route)
            });
            
            if (res.ok) {
                editingRouteId = null;
                document.getElementById('routeName').value = '';
                resetRouteBuilderState();
                await loadRoutes();
            }
        });

        async function loadRoutes() {
            const [routesRes, busRoutesRes] = await Promise.all([
                fetch('/api/routes'),
                fetch('/api/bus-routes')
            ]);
            const routes = await routesRes.json();
            const busRoutes = await busRoutesRes.json();
            renderRoutes(routes, busRoutes);
        }

        function renderRoutes(routes, busRoutes) {
            const container = document.getElementById('routesList');
            if (routes.length === 0) {
                container.innerHTML = '<div class="empty">No routes yet - create one!</div>';
                return;
            }
            container.innerHTML = '';
            routes.forEach(route => {
                // Determine status: running if any active bus is assigned to this route
                const isRunning = Object.values(busRoutes || {}).some(rid => String(rid) === String(route.id));
                const namedStops = (route.stops || []).filter(s => s && String(s).trim());
                const stopCount = namedStops.length || route.waypoints.length;
                const stopPreview = namedStops.slice(0, 2).join(' ‚Üí ');
                const card = document.createElement('div');
                card.className = 'route-card';
                card.style.borderLeftColor = route.color;
                card.innerHTML = `
                    <div class="route-name">${route.name}</div>
                    <div class="route-info">
                        <div>üõë ${stopCount} stops</div>
                        <div style="margin-top:4px"><span class="route-badge ${isRunning ? 'badge-running' : 'badge-idle'}">${isRunning ? 'Running' : 'Idle'}</span></div>
                        <div style="margin-top:4px; color:#667eea">${stopPreview}</div>
                    </div>
                    <div class="route-actions">
                        <button class="ok" style="background:rgba(102,126,234,0.1)" onclick="editRoute('${route.id}')">‚úèÔ∏è Edit</button>
                        <button class="danger" style="background:rgba(255,123,138,0.05)" onclick="deleteRoute('${route.id}')">üóëÔ∏è Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.editRoute = async (routeId) => {
            const res = await fetch('/api/routes');
            const routes = await res.json();
            const route = routes.find(r => r.id === routeId);
            if (route) {
                document.querySelector('[data-tab="routes"]').click();
                setTimeout(() => {
                    document.getElementById('routeName').value = route.name;
                    document.getElementById('routeColor').value = route.color;
                    currentWaypoints = JSON.parse(JSON.stringify(route.waypoints));
                    currentStops = JSON.parse(JSON.stringify(route.stops || []));
                    ensureStopsArraySize();
                    editingRouteId = routeId;
                    mapMode = 'stops';
                    updateSteps();
                    updateInstructions();
                    renderMapWaypoints();
                    renderStopsList();
                    window.scrollTo(0, 0);
                }, 200);
            }
        };

        window.deleteRoute = async (routeId) => {
            await fetch(`/api/route/${routeId}`, { method: 'DELETE' });
            await loadRoutes();
        };

        // ==== BUSES ====
        async function loadBuses() {
            const res = await fetch('/api/buses');
            const buses = await res.json();
            renderBuses(buses);
        }

        function renderBuses(buses) {
            const keys = Object.keys(buses).sort((a,b) => parseInt(a)-parseInt(b));
            const container = document.getElementById('busList');
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty">No active transports</div>';
                return;
            }
            // Build table once if not present, else update rows incrementally
            let table = container.querySelector('table');
            if(!table){
                container.innerHTML = '<table><thead><tr><th>Transport</th><th>Latitude</th><th>Longitude</th><th>Last Update</th><th></th></tr></thead><tbody></tbody></table>';
                table = container.querySelector('table');
            }
            const tbody = table.querySelector('tbody');
            const existingRows = new Set(Array.from(tbody.querySelectorAll('tr')).map(r=>r.getAttribute('data-bus')));
            // Add or update rows
            keys.forEach(k=>{
                const b = buses[k];
                let row = tbody.querySelector(`tr[data-bus="${k}"]`);
                if(!row){
                    row = document.createElement('tr');
                    row.setAttribute('data-bus', k);
                    row.innerHTML = `
                        <td><strong>Transport ${k}</strong></td>
                        <td><input class="lat" value="${b.lat}" style="width:140px"></td>
                        <td><input class="lng" value="${b.lng}" style="width:140px"></td>
                        <td class="small muted">${b.lastUpdate || ''}</td>
                        <td class="row-actions"><button class="save ok">Save</button><button class="remove danger">Remove</button></td>
                    `;
                    tbody.appendChild(row);
                    row.querySelector('.save').addEventListener('click', onSaveBus);
                    row.querySelector('.remove').addEventListener('click', onRemoveBus);
                } else {
                    // Skip update if user is editing inputs in this row
                    const activeEl = document.activeElement;
                    if(!(activeEl && row.contains(activeEl))){
                        const latInput = row.querySelector('.lat');
                        const lngInput = row.querySelector('.lng');
                        const lastCell = row.querySelector('.small.muted');
                        if(latInput && String(latInput.value) !== String(b.lat)) latInput.value = b.lat;
                        if(lngInput && String(lngInput.value) !== String(b.lng)) lngInput.value = b.lng;
                        if(lastCell && lastCell.textContent !== (b.lastUpdate||'')) lastCell.textContent = b.lastUpdate || '';
                    }
                }
                existingRows.delete(k);
            });
            // Remove rows for buses no longer present
            existingRows.forEach(k=>{
                const row = tbody.querySelector(`tr[data-bus="${k}"]`);
                if(row){ try{ row.remove(); }catch(e){} }
            });
            // Empty state
            if(tbody.children.length===0){ container.innerHTML = '<div class="empty">No active transports</div>'; }
        }

        async function onSaveBus(e) {
            const row = e.target.closest('tr');
            const busNum = row.getAttribute('data-bus');
            const lat = parseFloat(row.querySelector('.lat').value);
            const lng = parseFloat(row.querySelector('.lng').value);
            if (isNaN(lat) || isNaN(lng)) { alert('Enter valid coordinates'); return; }
            await fetch(`/api/bus/${busNum}`, {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ lat: lat, lng: lng, lastUpdate: new Date().toISOString() })
            });
            await loadBuses();
        }

        async function onRemoveBus(e) {
            const row = e.target.closest('tr');
            const busNum = row.getAttribute('data-bus');
            await fetch(`/api/bus/${busNum}`, { method: 'DELETE' });
            await loadBuses();
        }

        document.getElementById('refreshBtn').addEventListener('click', loadBuses);
        const perfRefreshBtn = document.getElementById('perfRefreshBtn');
        if (perfRefreshBtn) perfRefreshBtn.addEventListener('click', loadServerPerformance);
        const perfExportMdBtn = document.getElementById('perfExportMdBtn');
        const perfExportTxtBtn = document.getElementById('perfExportTxtBtn');
        if (perfExportMdBtn) perfExportMdBtn.addEventListener('click', () => downloadPerfExport('md'));
        if (perfExportTxtBtn) perfExportTxtBtn.addEventListener('click', () => downloadPerfExport('txt'));
        document.getElementById('clearAllBtn').addEventListener('click', async () => {
            if (!confirm('Clear all transports?')) return;
            await fetch('/api/buses/clear', { method: 'POST' });
            await loadBuses();
        });
        document.getElementById('addBtn').addEventListener('click', async () => {
            const num = document.getElementById('newBusNum').value.trim();
            const lat = parseFloat(document.getElementById('newLat').value);
            const lng = parseFloat(document.getElementById('newLng').value);
            if (!num || isNaN(lat) || isNaN(lng)) { alert('Provide transport number and coords'); return; }
            await fetch(`/api/bus/${num}`, {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ lat: lat, lng: lng, lastUpdate: new Date().toISOString() })
            });
            document.getElementById('newBusNum').value='';
            document.getElementById('newLat').value='';
            document.getElementById('newLng').value='';
            await loadBuses();
        });

        // Auto-refresh for transports list (paused when SSE connected)
        let busesAutoRefreshId = null;
        let isBusesRefreshing = false;
        let sseConnected = false;
        function startBusesAutoRefresh(){
            stopBusesAutoRefresh();
            busesAutoRefreshId = setInterval(async ()=>{
                const busesTab = document.getElementById('buses');
                const busListEl = document.getElementById('busList');
                if(!busesTab || !busesTab.classList.contains('active')) return;
                if(document.hidden) return;
                if(sseConnected) return; // let SSE drive incremental updates
                if(isBusesRefreshing) return;
                const activeEl = document.activeElement;
                if(activeEl && busListEl && busListEl.contains(activeEl) && (activeEl.tagName==='INPUT' || activeEl.tagName==='BUTTON')) return;
                try{
                    isBusesRefreshing = true;
                    // Soft refresh via incremental update
                    const res = await fetch('/api/buses');
                    const buses = await res.json();
                    renderBuses(buses);
                } finally { isBusesRefreshing = false; }
            }, 6000);
        }
        function stopBusesAutoRefresh(){
            if(busesAutoRefreshId){ try{ clearInterval(busesAutoRefreshId); }catch(e){} busesAutoRefreshId = null; }
        }

        // Initial load and start auto refresh (buses tab is active by default)
        loadBuses();
        startBusesAutoRefresh();
        window.addEventListener('beforeunload', () => {
            stopBusesAutoRefresh();
            stopPerfAutoRefresh();
        });

        // Live updates via SSE
        try{
            const es = new EventSource('/events');
            es.onopen = ()=>{ sseConnected = true; stopBusesAutoRefresh(); };
            es.onmessage = (ev)=>{
                try{
                    const msg = JSON.parse(ev.data);
                    if(msg.type === 'bus_update'){
                        const k = msg.bus; const b = msg.data||{};
                        const table = document.getElementById('busList').querySelector('table');
                        if(table){ renderBuses({ [k]: b }); }
                    } else if(msg.type === 'bus_stop'){
                        const row = document.querySelector(`#busList tr[data-bus="${msg.bus}"]`);
                        if(row) row.remove();
                    } else if(msg.type === 'buses_clear'){
                        document.getElementById('busList').innerHTML = '<div class="empty">No active transports</div>';
                    }
                }catch(e){ /* ignore */ }
            };
            es.onerror = ()=>{ sseConnected = false; startBusesAutoRefresh(); };
        }catch(e){ /* SSE not available, fallback to polling only */ }

        // ==== BUILDINGS MAP ====
        function initBuildingsMap() {
            if (buildingsMap) return;
            const bounds = [[20.339920625677212, 85.7964659296332], [20.37210882553945, 85.83388810783698]];
            buildingsMap = L.map('buildingsMap', { maxBounds: bounds, minZoom: 14 }).setView([20.3549, 85.8161], 15);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                maxZoom: 19
            }).addTo(buildingsMap);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
                attribution: '',
                maxZoom: 19
            }).addTo(buildingsMap);

            buildingsMap.on('click', (e) => {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                
                if (pendingHostelName) {
                    addHostelToMap(lat, lng);
                } else if (pendingClassName) {
                    addClassToMap(lat, lng);
                }
            });
            
            renderBuildingMarkers();
        }

        async function addHostelToMap(lat, lng) {
            const name = pendingHostelName;
            const capacity = pendingHostelCapacity || 100;
            
            const res = await fetch('/api/hostel', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name, lat, lng, capacity: parseInt(capacity) })
            });
            
            if (res.ok) {
                document.getElementById('hostelName').value = '';
                document.getElementById('hostelCapacity').value = '100';
                pendingHostelName = null;
                pendingHostelCapacity = null;
                document.getElementById('addHostelBtn').textContent = '+ Place on Map';
                document.getElementById('addHostelBtn').style.background = 'rgba(52,211,153,0.1)';
                await loadHostels();
            }
        }

        async function addClassToMap(lat, lng) {
            const name = pendingClassName;
            const department = pendingClassDept || 'Unknown';
            
            const res = await fetch('/api/class', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ name, lat, lng, department })
            });
            
            if (res.ok) {
                document.getElementById('className').value = '';
                document.getElementById('classDept').value = '';
                pendingClassName = null;
                pendingClassDept = null;
                document.getElementById('addClassBtn').textContent = '+ Place on Map';
                document.getElementById('addClassBtn').style.background = 'rgba(52,211,153,0.1)';
                await loadClasses();
            }
        }

        async function loadHostels() {
            try {
                const res = await fetch('/api/hostels');
                const hostels = await res.json();
                document.getElementById('hostelCount').textContent = hostels.length;
                renderHostelsList(hostels);
            } catch(e) { console.error(e); }
        }

        async function loadClasses() {
            try {
                const res = await fetch('/api/classes');
                const classes = await res.json();
                document.getElementById('classCount').textContent = classes.length;
                renderClassesList(classes);
            } catch(e) { console.error(e); }
        }

        function renderHostelsList(hostels) {
            const container = document.getElementById('hostelsList');
            if (hostels.length === 0) {
                container.innerHTML = '<div class="empty" style="font-size:12px; padding:10px">No hostels yet</div>';
                return;
            }
            
            container.innerHTML = hostels.map(h => `
                <div style="padding:8px; background:#07101a; border-radius:4px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; font-size:12px">
                    <div>
                        <div style="font-weight:600">${h.name}</div>
                        <div style="color:#9aa4b2; font-size:11px">${h.capacity} capacity</div>
                    </div>
                    <button onclick="deleteHostel('${h.id}')" style="background:#ff5722; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px">‚úï</button>
                </div>
            `).join('');
        }

        function renderClassesList(classes) {
            const container = document.getElementById('classesList');
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty" style="font-size:12px; padding:10px">No classes yet</div>';
                return;
            }
            
            container.innerHTML = classes.map(c => `
                <div style="padding:8px; background:#07101a; border-radius:4px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; font-size:12px">
                    <div>
                        <div style="font-weight:600">${c.name}</div>
                        <div style="color:#9aa4b2; font-size:11px">${c.department}</div>
                    </div>
                    <button onclick="deleteClass('${c.id}')" style="background:#ff5722; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer; font-size:11px">‚úï</button>
                </div>
            `).join('');
        }

        function renderBuildingMarkers() {
            if (!buildingsMap) return;
            
            Object.values(buildingMarkers).forEach(m => {
                try { buildingsMap.removeLayer(m); } catch(e) {}
            });
            buildingMarkers = {};
            
            fetch('/api/hostels').then(r => r.json()).then(hostels => {
                hostels.forEach(h => {
                    const icon = L.divIcon({ className: 'marker-wrapper', html: '<span class="tiny-marker tiny-hostel"></span>', iconSize:[10,10], iconAnchor:[5,5] });
                    const marker = L.marker([h.lat, h.lng], { icon }).bindPopup(`<b>${h.name}</b><br/>Capacity: ${h.capacity}`).addTo(buildingsMap);
                    buildingMarkers[h.id] = marker;
                });
            });
            
            fetch('/api/classes').then(r => r.json()).then(classes => {
                classes.forEach(c => {
                    const icon = L.divIcon({ className: 'marker-wrapper', html: '<span class="tiny-marker tiny-class"></span>', iconSize:[10,10], iconAnchor:[5,5] });
                    const marker = L.marker([c.lat, c.lng], { icon }).bindPopup(`<b>${c.name}</b><br/>${c.department}`).addTo(buildingsMap);
                    buildingMarkers[c.id] = marker;
                });
            });
        }

        async function deleteHostel(id) {
            await fetch(`/api/hostel/${id}`, { method: 'DELETE' });
            await loadHostels();
            renderBuildingMarkers();
        }

        async function deleteClass(id) {
            await fetch(`/api/class/${id}`, { method: 'DELETE' });
            await loadClasses();
            renderBuildingMarkers();
        }

        document.getElementById('addHostelBtn').addEventListener('click', () => {
            const name = document.getElementById('hostelName').value.trim();
            if (!name) { alert('Enter hostel name'); return; }
            pendingHostelName = name;
            pendingHostelCapacity = document.getElementById('hostelCapacity').value;
            document.getElementById('addHostelBtn').textContent = 'üìç Click on map...';
            document.getElementById('addHostelBtn').style.background = 'rgba(102,126,234,0.2)';
            setTimeout(initBuildingsMap, 100);
        });

        document.getElementById('addClassBtn').addEventListener('click', () => {
            const name = document.getElementById('className').value.trim();
            if (!name) { alert('Enter class name'); return; }
            pendingClassName = name;
            pendingClassDept = document.getElementById('classDept').value;
            document.getElementById('addClassBtn').textContent = 'üìç Click on map...';
            document.getElementById('addClassBtn').style.background = 'rgba(102,126,234,0.2)';
            setTimeout(initBuildingsMap, 100);
        });
    </script>
</body>
</html>
