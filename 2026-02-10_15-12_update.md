# Campus Transport Update — 2026-02-10 15:12

**Commit:** `273f0da`
**Branch:** `main`
**Files Changed:** `app.py`, `templates/student.html`, `templates/simulator.html`

---

## Overview

This update addresses nine issues spanning frontend UX bugs, backend broadcast reliability, theme aesthetics, and performance tuning. The focus was on fixing stale data problems (ETA not rendering, buses going silent, UI freezing on idle tabs) while refining the visual identity of the student interface with a cohesive purplish theme.

---

## 1. ETA Display Fix

**Problem:** When a student selected a route, the ETA panel remained blank. The estimated arrival time would only appear after several seconds, or sometimes not at all.

**Root Cause:** The `maybeUpdateStudentEta` function enforced a 2500ms throttle on all DOM updates, including the very first one. Since `studentEtaLastHtml` started as `null`, the initial HTML was treated as a duplicate or throttled out.

**Fix:** Added an `isFirst` flag that checks if `studentEtaLastHtml === null`. First-time ETA updates now bypass the throttle entirely, ensuring the panel populates immediately on route selection. Subsequent updates still respect the 2.5s throttle to avoid excessive DOM writes.

---

## 2. Stationary Bus Heartbeat (Backend)

**Problem:** When a bus stopped moving for more than 5 seconds, its status on the student UI would freeze for 20–30 seconds. The bus appeared stuck in "Moving" state long after it had stopped.

**Root Cause:** The backend's `update_bus_location` endpoint suppressed SSE broadcasts when the position delta was below 0.000005 degrees (~0.5m). A stationary bus sent identical coordinates, so every update was silently dropped — no broadcast meant no status change on the frontend.

**Fix:** Introduced a time-based heartbeat check. Even when position is unchanged, the server now broadcasts an update every 5 seconds. It compares the current timestamp against the bus's `lastUpdate` field and only suppresses the broadcast if less than 5 seconds have elapsed. This ensures clients always receive timely status transitions (Moving → Stationary) without flooding the SSE channel.

---

## 3. SSE Health Watchdog & Tab Refocus Recovery

**Problem:** The student UI would silently stop receiving updates after 30 seconds to 2 minutes of inactivity. Switching tabs or leaving the page idle caused the SSE connection to die without triggering an error, and the polling fallback wasn't restarted.

**Root Cause:** Two issues compounded:
- The `visibilitychange` handler only restarted polling when SSE was known to be disconnected, but SSE could silently enter `readyState === 2` (closed) without updating the `sseConnected` flag.
- The `__resyncTimer` interval was not being cleared before re-creation, leading to timer leaks.

**Fix:**
- **Tab refocus:** On `visibilitychange` (hidden → visible), the handler now immediately calls `updateBuses()`, checks SSE `readyState`, reconnects if dead, and always ensures the polling interval is running as a fallback.
- **SSE watchdog:** A `_sseLastMsg` timestamp is recorded on every SSE message. The resync timer checks if no message has been received in 45 seconds (server heartbeat is 20s). If the threshold is exceeded, SSE is forcibly closed and reconnected. This catches silent connection drops that don't fire `onerror`.

---

## 4. Route Transport List — Type Coercion & Color Fix

**Problem:** The "Transports on Route" sidebar showed incorrect bus counts, displayed wrong buses, and occasionally crashed with undefined colors. The list also failed to refresh when buses changed routes.

**Root Cause:** Route IDs were compared with strict equality (`===`) but arrived as different types — numbers from the backend, strings from the DOM. `1 === "1"` evaluates to `false`, so buses were silently filtered out. Additionally, `parseInt(bus.busNum)` returned `NaN` for non-numeric bus identifiers, causing `colors[NaN % 20]` to resolve to `undefined`.

**Fix:**
- All route ID comparisons across `renderRouteBusByETA`, `showRouteDetails`, and `computeAndShowStudentETA` now wrap both sides in `String()` for consistent comparison.
- The `busRouteMap` lookup adds a null guard (`busRouteMap[busNum] != null`) before coercion.
- Color indexing uses `parseInt(bus.busNum) || 0` with a lower-bound check, so non-numeric IDs default to the first color instead of crashing.

---

## 5. Purplish Theme & Aesthetic Refinements

**Goal:** Give all non-map sections a subtle purplish tint while keeping the overall dark/light theme consistent.

**Changes:**
- **Dark mode:** `--card-bg` shifted from `rgba(18, 24, 38, 0.55)` (blue-gray) to `rgba(22, 20, 42, 0.55)` (deep purple). `--card-border` changed from `rgba(255,255,255,0.06)` to `rgba(130, 100, 255, 0.10)`.
- **Light mode:** `--card-border` shifted from `rgba(0,0,0,0.08)` to `rgba(100, 80, 200, 0.10)` for a soft lavender edge.
- The sidebar, route cards, ETA panel, and all card-bordered elements inherit these values automatically through CSS custom properties.

---

## 6. Map Border

**Goal:** Add a clean, aesthetic border around the map that complements the purplish theme.

**Change:** The `#map` element's border was updated from a simple `2px solid var(--map-border)` to a layered effect:
- `border: 2px solid rgba(255, 255, 255, 0.18)` — subtle white edge
- `box-shadow: 0 0 0 1px rgba(130, 100, 255, 0.12), 0 8px 28px var(--card-shadow)` — inner purple glow + soft depth shadow

This creates a frosted-glass appearance that ties into the purple card borders.

---

## 7. Label Rename

**Change:** "Walk Distance" renamed to "Nearest Stop" in the student ETA panel. The underlying functionality is unchanged — it still shows the closest stop on the selected route and the walking distance to it.

---

## 8. Simulator Trail Z-Order

**Problem:** In the simulator, bus trail polylines were rendered beneath route lines, making them invisible when overlapping.

**Fix:** After the route polyline is drawn in `showRouteOnMap`, both the trail and the bus marker are explicitly brought to the front via `trail.bringToFront()` and `marker.bringToFront()`. This ensures the trail is always visible on top of route geometry.

---

## 9. Tile Performance Optimization

**Goal:** Reduce map tile loading overhead without visibly degrading detail.

**Changes to `TILE_OPTS`:**
| Setting | Before | After | Effect |
|---------|--------|-------|--------|
| `updateWhenIdle` | `false` | `true` | Tiles load only after pan/zoom finishes, not during |
| `keepBuffer` | `6` | `4` | Fewer off-screen tiles kept in memory |
| `detectRetina` | *(default)* | `false` | Prevents loading 4x tiles on high-DPI screens |

These changes reduce network requests and memory usage during map interaction with negligible visual impact at the zoom levels used for campus navigation.

---

## Summary

| Category | Items |
|----------|-------|
| Bug Fixes | ETA display, stationary heartbeat, SSE watchdog, route list type coercion, tab refocus |
| UI/UX | Purplish theme, map border, label rename |
| Performance | Tile loading optimization |
| Simulator | Trail z-ordering |

All changes maintain backward compatibility. No API contract changes. No new dependencies.
